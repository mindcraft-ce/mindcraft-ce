<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics & Analytics - Andy API Local Client</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        .header h1 {
            color: white;
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .nav a:hover, .nav a.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.4em;
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        .metric-change {
            font-size: 0.8em;
            margin-top: 5px;
        }
        .change-positive { color: #4CAF50; }
        .change-negative { color: #f44336; }
        .change-neutral { color: #666; }
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .chart-canvas {
            width: 100%;
            height: 400px;
        }
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        .real-time-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .indicator {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f0f4ff;
        }
        .indicator-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        .indicator-label {
            color: #666;
            font-size: 0.8em;
            margin-top: 5px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background-color: #4CAF50; }
        .status-disconnected { background-color: #f44336; }
        .pool-status {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .pool-status.fallback {
            background: linear-gradient(45deg, #FFA726, #FF7043);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Metrics & Analytics</h1>
            <div class="nav">
                <a href="/">Dashboard</a>
                <a href="/models">Models</a>
                <a href="/metrics" class="active">Metrics</a>
                <a href="/settings">Settings</a>
                <a href="https://mindcraft.riqvip.dev" target="_blank">Central Pool</a>
            </div>
        </div>

        <!-- Pool Status Banner -->
        <div class="pool-status" id="poolStatus">
            <span class="status-indicator status-connected"></span>
            <strong>Connected to Andy API Pool</strong> - Serving requests from shared compute
        </div>

        <!-- Real-time Metrics -->
        <div class="metrics-grid">
            <div class="card">
                <h3>üöÄ Requests</h3>
                <div class="metric-value" id="totalRequests">{{ stats.total_requests }}</div>
                <div class="metric-label">Total Requests Handled</div>
                <div class="metric-change change-positive" id="requestsChange">
                    +0 since last hour
                </div>
            </div>

            <div class="card">
                <h3>‚ö° Performance</h3>
                <div class="metric-value" id="tokensPerSecond">{{ '%.1f'|format(stats.average_tokens_per_second) }}</div>
                <div class="metric-label">Tokens per Second</div>
                <div class="metric-change change-neutral" id="performanceChange">
                    Stable
                </div>
            </div>

            <div class="card">
                <h3>‚úÖ Success Rate</h3>
                <div class="metric-value" id="successRate">
                    {% if stats.total_requests > 0 %}
                        {{ '%.1f'|format((stats.successful_requests / stats.total_requests) * 100) }}%
                    {% else %}
                        100%
                    {% endif %}
                </div>
                <div class="metric-label">Request Success Rate</div>
                <div class="metric-change change-positive" id="successChange">
                    Excellent
                </div>
            </div>

            <div class="card">
                <h3>üß† Models</h3>
                <div class="metric-value" id="activeModels">{{ models.values()|selectattr('enabled')|list|length }}</div>
                <div class="metric-label">Active Models</div>
                <div class="metric-change change-neutral" id="modelsChange">
                    Ready to serve
                </div>
            </div>

            <div class="card">
                <h3>‚è±Ô∏è Uptime</h3>
                <div class="metric-value" id="uptime">
                    {{ uptime_hours }}h
                </div>
                <div class="metric-label">Client Uptime</div>
                <div class="metric-change change-positive" id="uptimeChange">
                    Running smoothly
                </div>
            </div>

            <div class="card">
                <h3>üíæ Pool VRAM</h3>
                <div class="metric-value" id="totalVram">{{ client.config.max_vram_gb }}GB</div>
                <div class="metric-label">Available VRAM</div>
                <div class="metric-change change-neutral" id="vramChange">
                    This client
                </div>
            </div>
        </div>

        <!-- Current Load Indicators -->
        <div class="chart-container">
            <h3>üî• Real-time Load</h3>
            <div class="real-time-indicators">
                <div class="indicator">
                    <div class="indicator-value" id="currentLoad">0</div>
                    <div class="indicator-label">Active Requests</div>
                </div>
                <div class="indicator">
                    <div class="indicator-value" id="queueLength">0</div>
                    <div class="indicator-label">Queue Length</div>
                </div>
                <div class="indicator">
                    <div class="indicator-value" id="vramUsage">0%</div>
                    <div class="indicator-label">VRAM Usage</div>
                </div>
                <div class="indicator">
                    <div class="indicator-value" id="responseTime">0ms</div>
                    <div class="indicator-label">Avg Response Time</div>
                </div>
            </div>
        </div>

        <!-- Historical Charts -->
        <div class="chart-container">
            <div class="chart-controls">
                <h3>üìà Historical Data</h3>
                <div>
                    <button class="btn active" onclick="changeTimeRange(24)">24 Hours</button>
                    <button class="btn" onclick="changeTimeRange(168)">7 Days</button>
                    <button class="btn" onclick="changeTimeRange(720)">30 Days</button>
                    <button class="btn" onclick="changeTimeRange(2160)">3 Months</button>
                </div>
            </div>
            <canvas id="historicalChart" class="chart-canvas"></canvas>
        </div>

        <!-- Requests per Minute Chart -->
        <div class="chart-container">
            <h3>üìä Requests per Minute</h3>
            <canvas id="requestsChart" class="chart-canvas"></canvas>
        </div>

        <!-- Performance Distribution -->
        <div class="chart-container">
            <h3>üéØ Performance Distribution</h3>
            <canvas id="performanceChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <script>
        let currentTimeRange = 24; // hours
        let updateInterval;

        // Initialize charts
        const historicalCtx = document.getElementById('historicalChart').getContext('2d');
        const requestsCtx = document.getElementById('requestsChart').getContext('2d');
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');

        // Historical chart
        const historicalChart = new Chart(historicalCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Tokens/sec',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Response Time (ms)',
                    data: [],
                    borderColor: '#ff9800',
                    backgroundColor: 'rgba(255, 152, 0, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Tokens per Second'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Response Time (ms)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });

        // Requests per minute chart
        const requestsChart = new Chart(requestsCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Requests',
                    data: [],
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: '#667eea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Requests per Minute'
                        }
                    }
                }
            }
        });

        // Performance distribution chart (doughnut)
        const performanceChart = new Chart(performanceCtx, {
            type: 'doughnut',
            data: {
                labels: ['Successful', 'Failed', 'In Progress'],
                datasets: [{
                    data: [{{ stats.successful_requests }}, {{ stats.failed_requests }}, 0],
                    backgroundColor: ['#4CAF50', '#f44336', '#ff9800'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Functions
        function changeTimeRange(hours) {
            currentTimeRange = hours;
            
            // Update button states
            document.querySelectorAll('.chart-controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload data
            loadMetricsData();
        }

        async function loadMetricsData() {
            try {
                const response = await fetch(`/api/metrics_data?hours=${currentTimeRange}`);
                const data = await response.json();
                
                if (data.metrics) {
                    updateHistoricalChart(data.metrics);
                    updateRequestsChart(data.metrics);
                }
                
                if (data.current_stats) {
                    updateRealTimeMetrics(data.current_stats);
                }
                
                updatePoolStatus(data.current_stats);
                
            } catch (error) {
                console.error('Error loading metrics data:', error);
            }
        }

        function updateHistoricalChart(metrics) {
            const labels = metrics.map(m => new Date(m[0]).toLocaleTimeString());
            const tokensData = metrics.map(m => m[3] || 0);
            const responseData = metrics.map(m => (m[2] || 0) * 1000); // Convert to ms
            
            historicalChart.data.labels = labels;
            historicalChart.data.datasets[0].data = tokensData;
            historicalChart.data.datasets[1].data = responseData;
            historicalChart.update('none');
        }

        function updateRequestsChart(metrics) {
            const labels = metrics.map(m => new Date(m[0]).toLocaleTimeString());
            const requestsData = metrics.map(m => m[1] || 0);
            
            requestsChart.data.labels = labels;
            requestsChart.data.datasets[0].data = requestsData;
            requestsChart.update('none');
        }

        function updateRealTimeMetrics(stats) {
            document.getElementById('totalRequests').textContent = stats.total_requests;
            document.getElementById('tokensPerSecond').textContent = stats.average_tokens_per_second.toFixed(1);
            document.getElementById('activeModels').textContent = stats.enabled_models;
            
            const successRate = stats.total_requests > 0 ? 
                ((stats.successful_requests / stats.total_requests) * 100).toFixed(1) : 100;
            document.getElementById('successRate').textContent = successRate + '%';
            
            const uptimeHours = (stats.uptime / 3600).toFixed(1);
            document.getElementById('uptime').textContent = uptimeHours + 'h';
            
            // Update real-time indicators
            document.getElementById('currentLoad').textContent = '0'; // Would need actual load tracking
            document.getElementById('queueLength').textContent = '0';
            document.getElementById('vramUsage').textContent = '0%';
            document.getElementById('responseTime').textContent = '0ms';
            
            // Update performance chart
            performanceChart.data.datasets[0].data = [
                stats.successful_requests,
                stats.total_requests - stats.successful_requests,
                0
            ];
            performanceChart.update('none');
        }

        function updatePoolStatus(stats) {
            const poolStatusEl = document.getElementById('poolStatus');
            const indicator = poolStatusEl.querySelector('.status-indicator');
            
            if (stats.connected) {
                poolStatusEl.className = 'pool-status';
                indicator.className = 'status-indicator status-connected';
                poolStatusEl.innerHTML = `
                    <span class="status-indicator status-connected"></span>
                    <strong>Connected to Andy API Pool</strong> - Serving requests from shared compute
                `;
            } else {
                poolStatusEl.className = 'pool-status fallback';
                indicator.className = 'status-indicator status-disconnected';
                poolStatusEl.innerHTML = `
                    <span class="status-indicator status-disconnected"></span>
                    <strong>Pool Capacity: 0</strong> - All requests forwarded to Pollinations API
                `;
            }
        }

        // Auto-update every 30 seconds
        function startAutoUpdate() {
            loadMetricsData(); // Initial load
            updateInterval = setInterval(loadMetricsData, 30000);
        }

        // Generate some fake real-time data for demonstration
        function simulateRealTimeData() {
            const currentLoad = Math.floor(Math.random() * 5);
            const queueLength = Math.floor(Math.random() * 3);
            const vramUsage = Math.floor(Math.random() * 80) + 10;
            const responseTime = Math.floor(Math.random() * 500) + 100;
            
            document.getElementById('currentLoad').textContent = currentLoad;
            document.getElementById('queueLength').textContent = queueLength;
            document.getElementById('vramUsage').textContent = vramUsage + '%';
            document.getElementById('responseTime').textContent = responseTime + 'ms';
        }

        // Start everything
        startAutoUpdate();
        setInterval(simulateRealTimeData, 5000); // Update real-time indicators every 5 seconds

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
